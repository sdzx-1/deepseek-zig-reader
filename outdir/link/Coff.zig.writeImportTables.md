graph TD
    A[开始] --> B{检查条件}
    B -->|idata_section_index为null或imports_count_dirty为false| C[返回]
    B -->|条件不满足| D[计算各部分大小]
    D --> E[遍历import_tables]
    E --> F[计算iat_size, dir_table_size等]
    D --> G[计算总大小needed_size]
    G --> H[扩展section]
    H --> I[初始化buffer]
    I --> J[设置各offset初始值]
    J --> K[遍历import_tables写入数据]
    K --> L[填充ImportDirectoryEntry]
    L --> M[处理每个entry]
    M --> N[写入IAT和Lookup表]
    N --> O[处理名称和对齐]
    O --> P[写入sentinel]
    K --> Q[写入DLL名称]
    Q --> R[填充sentinel ImportDirectoryEntry]
    R --> S[验证dll_names_offset]
    S --> T[写入buffer到section]
    T --> U[更新数据目录]
    U --> V[标记imports_count_dirty为false]
    V --> W[结束]
