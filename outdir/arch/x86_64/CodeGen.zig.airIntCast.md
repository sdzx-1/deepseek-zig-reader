graph TD
    A[开始: airIntCast] --> B[获取源类型src_ty和目标类型dst_ty]
    B --> C{目标类型是向量?}
    C --> |是| D[向量处理分支]
    C --> |否| M[标量处理分支]
    
    D --> E[比较元素大小: dst_elem vs src_elem]
    E --> |lt| F[处理缩小转换]
    E --> |eq| G[直接重用或复制寄存器]
    E --> |gt| H[处理扩展转换]
    
    F --> F1[选择缩小指令(mir_tag)]
    F1 --> F2{是否有AVX?}
    F2 --> |是| F3[使用VP指令]
    F2 --> |否| F4[使用P指令]
    F3/F4 --> F5[分配/重用寄存器]
    F5 --> F6[生成指令]
    F6 --> R[返回结果]
    
    G --> G1{可重用操作数?}
    G1 --> |是| G2[直接返回src_mcv]
    G1 --> |否| G3[复制到新寄存器]
    G3 --> R
    
    H --> H1{是否支持SSE4.1?}
    H1 --> |是| H2[使用MOVSX/MOVZX指令]
    H1 --> |否| H3[使用解包指令]
    H2/H3 --> H4[分配/重用寄存器]
    H4 --> H5[生成扩展指令]
    H5 --> R
    
    M --> N[判断目标位数与源位数关系]
    N --> |dst_bits ≤ src_bits| O[截断处理]
    N --> |dst_bits > src_bits| P[扩展处理]
    
    O --> O1[生成截断指令]
    O1 --> O2[调整寄存器别名]
    O2 --> R
    
    P --> P1[处理高位部分]
    P1 --> P2{符号扩展?}
    P2 --> |是| P3[生成算术右移]
    P2 --> |否| P4[填充零]
    P3/P4 --> P5[生成memset扩展]
    P5 --> R
    
    C --> |无法处理| ERR[返回错误]
    F --> |无对应指令| ERR
    H --> |无对应指令| ERR
    P --> |异常情况| ERR
