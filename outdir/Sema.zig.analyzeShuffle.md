graph TD
    Start[开始] --> CheckAAndBType[检查a和b的类型是否为数组或向量]
    CheckAAndBType -->|是| GetALenAndBLen[获取a_len和b_len]
    CheckAAndBType -->|否| FailWithError[返回类型错误]
    GetALenAndBLen --> CheckNullAB[检查a_len和b_len是否都为null]
    CheckNullAB -->|是| ReturnUndef[返回undef结果]
    CheckNullAB -->|否| DetermineABLen[确定a_len和b_len的具体值]
    DetermineABLen --> CreateVectorTypes[创建a_ty和b_ty向量类型]
    CreateVectorTypes --> CoerceAB[对a和b进行类型强制转换]
    CoerceAB --> IterateMask[遍历mask的每个元素]
    IterateMask --> CheckElemUndef[检查mask元素是否为undef]
    CheckElemUndef -->|是| ContinueLoop[继续循环]
    CheckElemUndef -->|否| ResolveElem[解析mask元素值]
    ResolveElem --> CheckIndexBound[检查索引是否越界]
    CheckIndexBound -->|越界| GenerateError[生成越界错误信息]
    CheckIndexBound -->|未越界| ContinueLoop
    IterateMask -->|循环完成| CheckCompileValues[检查a和b是否在编译时已知]
    CheckCompileValues -->|已知| BuildAggregate[生成聚合值并返回]
    CheckCompileValues -->|未知| CheckABLength[检查a_len和b_len是否相同]
    CheckABLength -->|相同| GenerateShuffle[生成shuffle指令并返回]
    CheckABLength -->|不同| ExpandVector[扩展较短向量并递归调用]
    ExpandVector --> GenerateShuffle
    FailWithError --> End[结束]
    ReturnUndef --> End
    GenerateError --> End
    BuildAggregate --> End
    GenerateShuffle --> End
