好的，我需要总结这个Zig代码的主要函数流程。首先，我会仔细阅读代码，理解各个模块和结构体的作用。看起来这个代码是一个SPIR-V链接器的一部分，用于处理调用全局变量（invocation globals）的底层操作。

首先，代码中定义了一个`ModuleInfo`结构体，用来存储解析模块后的信息，包括函数、入口点、被调用者存储和调用全局变量。`parse`函数负责从二进制模块中提取这些信息，处理各种SPIR-V指令，如`OpEntryPoint`、`OpTypeFunction`、`OpExtInst`等。解析过程中，会收集函数的信息、入口点、调用关系以及调用全局变量。

接下来是`resolve`函数，它进一步处理模块信息，分为两个步骤：`resolveInvocationGlobalUsage`和`resolveInvocationGlobalDependencies`。前者确保每个函数的调用全局变量包含其所有被调用者的全局变量，后者解析每个调用全局变量的依赖关系，确保所有依赖都被正确记录。

然后是`ModuleBuilder`结构体，负责构建新的SPIR-V模块。`init`函数初始化构建器，`deriveNewFnInfo`生成新的函数信息，包括新的函数类型和全局变量ID。`emitFunctionTypes`生成新的函数类型指令，考虑参数类型的变化。`rewriteFunctions`重写函数指令，调整参数和调用以包含调用全局变量。`emitNewEntryPoints`生成新的入口点函数，处理调用全局变量的初始化和调用链。

最后，`run`函数是整个流程的入口，依次调用解析、解析后的处理、构建新模块的各个步骤，最终生成修改后的SPIR-V二进制。

在理解过程中，需要注意各个结构体如何协作，特别是`ModuleInfo`如何收集和解析信息，`ModuleBuilder`如何利用这些信息生成新的指令。同时，SPIR-V指令的处理和重写需要确保符合规范，比如函数类型的唯一性、参数的正确传递等。可能会遇到依赖解析不完整或ID分配冲突的问题，需要仔细处理。
================================================
### 主要函数流程总结

1. **模块解析 (`ModuleInfo.parse`)**  
   - **输入**: SPIR-V二进制模块。  
   - **流程**:  
     - 遍历二进制指令，提取函数、入口点、调用关系和调用全局变量（`invocation_globals`）。  
     - 处理关键指令：  
       - `OpEntryPoint`：记录入口点函数。  
       - `OpTypeFunction`：存储函数类型（返回类型和参数类型）。  
       - `OpExtInst`（特定扩展指令）：标记调用全局变量及其初始化器。  
       - `OpFunctionCall`：记录函数间的调用关系。  
       - `OpFunction`和`OpFunctionEnd`：提取函数参数和调用全局变量访问信息。  
   - **输出**: 包含函数、入口点、调用链和调用全局变量的`ModuleInfo`结构。

2. **依赖解析 (`ModuleInfo.resolve`)**  
   - **步骤 1**: `resolveInvocationGlobalUsage`  
     - 递归遍历函数调用链，将每个函数及其所有被调用者的调用全局变量合并到当前函数的全局变量集合中。  
   - **步骤 2**: `resolveInvocationGlobalDependencies`  
     - 解析每个调用全局变量的依赖关系（包括初始化器中的依赖），确保依赖链完整。

3. **模块构建 (`ModuleBuilder`)**  
   - **初始化 (`init`)**：分配ID范围，准备构建新模块。  
   - **生成新函数信息 (`deriveNewFnInfo`)**：  
     - 为每个函数生成新的函数类型（原参数类型前追加调用全局变量的类型）。  
     - 分配新参数ID。  
   - **发射函数类型 (`emitFunctionTypes`)**：  
     - 生成所有唯一的函数类型指令（`OpTypeFunction`），确保SPIR-V规范要求。  
   - **重写函数 (`rewriteFunctions`)**：  
     - 替换函数参数和调用指令，插入调用全局变量的参数传递。  
     - 调整`OpFunctionCall`以包含全局变量参数。  
   - **生成新入口点 (`emitNewEntryPoints`)**：  
     - 为每个入口点创建新函数，声明调用全局变量并初始化。  
     - 调用原始入口点函数，传递全局变量和参数。

4. **主流程 (`run`)**  
   - **步骤**:  
     1. 解析二进制模块并生成`ModuleInfo`。  
     2. 解析依赖关系。  
     3. 初始化构建器并生成新函数信息。  
     4. 发射前导指令（如非函数部分的指令）。  
     5. 发射新函数类型。  
     6. 重写函数逻辑。  
     7. 生成新入口点。  
     8. 输出最终修改后的SPIR-V二进制。

### 核心目标  
将**调用全局变量**隐式传递转换为显式函数参数，确保其在函数调用链中的正确传递和初始化，同时符合SPIR-V规范。