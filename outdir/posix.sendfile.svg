<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: sendfile_flowchart Pages: 1 -->
<svg width="891pt" height="689pt"
 viewBox="0.00 0.00 891.48 689.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 685)">
<title>sendfile_flowchart</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-685 887.48,-685 887.48,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_headers</title>
<polygon fill="none" stroke="black" points="257.48,-460 257.48,-618 525.48,-618 525.48,-460 257.48,-460"/>
<text text-anchor="middle" x="391.48" y="-602.8" font-family="Times,serif" font-size="14.00">Headers Handling</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_os_switch</title>
<polygon fill="none" stroke="black" points="323.48,-278 323.48,-441 875.48,-441 875.48,-278 323.48,-278"/>
<text text-anchor="middle" x="599.48" y="-425.8" font-family="Times,serif" font-size="14.00">OS&#45;specific Handling</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_fallback</title>
<polygon fill="none" stroke="black" points="38.48,-278 38.48,-441 246.48,-441 246.48,-278 38.48,-278"/>
<text text-anchor="middle" x="142.48" y="-425.8" font-family="Times,serif" font-size="14.00">Fallback Read/Write</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_trailers</title>
<polygon fill="none" stroke="black" points="448.48,-8 448.48,-249 635.48,-249 635.48,-8 448.48,-8"/>
<text text-anchor="middle" x="541.98" y="-233.8" font-family="Times,serif" font-size="14.00">Trailers Handling</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_error_handling</title>
<polygon fill="none" stroke="black" points="228.48,-91 228.48,-249 440.48,-249 440.48,-91 228.48,-91"/>
<text text-anchor="middle" x="334.48" y="-233.8" font-family="Times,serif" font-size="14.00">Error Handling (Simplified)</text>
</g>
<!-- start -->
<g id="node1" class="node">
<title>start</title>
<polygon fill="none" stroke="black" points="400.48,-681 346.48,-681 346.48,-645 400.48,-645 400.48,-681"/>
<text text-anchor="middle" x="373.48" y="-660.5" font-family="Arial" font-size="10.00">Start</text>
</g>
<!-- headers_check -->
<g id="node3" class="node">
<title>headers_check</title>
<polygon fill="none" stroke="black" points="419.48,-587 327.48,-587 327.48,-551 419.48,-551 419.48,-587"/>
<text text-anchor="middle" x="373.48" y="-566.5" font-family="Arial" font-size="10.00">headers.len != 0?</text>
</g>
<!-- start&#45;&gt;headers_check -->
<g id="edge3" class="edge">
<title>start&#45;&gt;headers_check</title>
<path fill="none" stroke="black" d="M373.48,-644.7C373.48,-631.46 373.48,-612.95 373.48,-597.66"/>
<polygon fill="black" stroke="black" points="376.98,-597.23 373.48,-587.23 369.98,-597.23 376.98,-597.23"/>
</g>
<!-- end -->
<g id="node2" class="node">
<title>end</title>
<polygon fill="none" stroke="black" points="568.48,-52 466.48,-52 466.48,-16 568.48,-16 568.48,-52"/>
<text text-anchor="middle" x="517.48" y="-31.5" font-family="Arial" font-size="10.00">Return total_written</text>
</g>
<!-- headers_writev -->
<g id="node4" class="node">
<title>headers_writev</title>
<polygon fill="none" stroke="black" points="393.48,-504 265.48,-504 265.48,-468 393.48,-468 393.48,-504"/>
<text text-anchor="middle" x="329.48" y="-489" font-family="Arial" font-size="10.00">Write headers via writev()</text>
<text text-anchor="middle" x="329.48" y="-478" font-family="Arial" font-size="10.00">Update total_written</text>
</g>
<!-- headers_check&#45;&gt;headers_writev -->
<g id="edge1" class="edge">
<title>headers_check&#45;&gt;headers_writev</title>
<path fill="none" stroke="black" d="M364.15,-550.82C358.2,-539.87 350.37,-525.46 343.66,-513.11"/>
<polygon fill="black" stroke="black" points="346.64,-511.27 338.8,-504.15 340.49,-514.61 346.64,-511.27"/>
<text text-anchor="middle" x="361.98" y="-525" font-family="Arial" font-size="10.00">Yes</text>
</g>
<!-- header_done_false -->
<g id="node5" class="node">
<title>header_done_false</title>
<polygon fill="none" stroke="black" points="516.98,-504 411.98,-504 411.98,-468 516.98,-468 516.98,-504"/>
<text text-anchor="middle" x="464.48" y="-483.5" font-family="Arial" font-size="10.00">header_done = false</text>
</g>
<!-- headers_check&#45;&gt;header_done_false -->
<g id="edge2" class="edge">
<title>headers_check&#45;&gt;header_done_false</title>
<path fill="none" stroke="black" d="M392.78,-550.82C405.81,-539.22 423.19,-523.75 437.57,-510.95"/>
<polygon fill="black" stroke="black" points="440.06,-513.42 445.21,-504.15 435.41,-508.19 440.06,-513.42"/>
<text text-anchor="middle" x="429.98" y="-525" font-family="Arial" font-size="10.00">No</text>
</g>
<!-- os_switch -->
<g id="node6" class="node">
<title>os_switch</title>
<polygon fill="none" stroke="black" points="513.48,-410 415.48,-410 415.48,-374 513.48,-374 513.48,-410"/>
<text text-anchor="middle" x="464.48" y="-389.5" font-family="Arial" font-size="10.00">Switch (native_os)</text>
</g>
<!-- headers_writev&#45;&gt;os_switch -->
<g id="edge8" class="edge">
<title>headers_writev&#45;&gt;os_switch</title>
<path fill="none" stroke="black" d="M354.55,-467.91C376.01,-453.29 407.1,-432.11 430.74,-415.99"/>
<polygon fill="black" stroke="black" points="432.79,-418.83 439.08,-410.31 428.84,-413.05 432.79,-418.83"/>
</g>
<!-- error_check -->
<g id="node16" class="node">
<title>error_check</title>
<polygon fill="none" stroke="black" points="369.48,-218 299.48,-218 299.48,-182 369.48,-182 369.48,-218"/>
<text text-anchor="middle" x="334.48" y="-197.5" font-family="Arial" font-size="10.00">Check errno</text>
</g>
<!-- headers_writev&#45;&gt;error_check -->
<g id="edge25" class="edge">
<title>headers_writev&#45;&gt;error_check</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M265.44,-484.82C187.8,-483.07 63.68,-474.88 34.48,-441 -12.82,-386.13 -9.93,-335.24 34.48,-278 65.52,-237.98 213.34,-215.16 289.25,-205.9"/>
<polygon fill="black" stroke="black" points="289.95,-209.34 299.47,-204.68 289.12,-202.39 289.95,-209.34"/>
</g>
<!-- header_done_false&#45;&gt;os_switch -->
<g id="edge9" class="edge">
<title>header_done_false&#45;&gt;os_switch</title>
<path fill="none" stroke="black" d="M464.48,-467.7C464.48,-454.46 464.48,-435.95 464.48,-420.66"/>
<polygon fill="black" stroke="black" points="467.98,-420.23 464.48,-410.23 460.98,-420.23 467.98,-420.23"/>
</g>
<!-- linux -->
<g id="node7" class="node">
<title>linux</title>
<polygon fill="none" stroke="black" points="597.48,-327 473.48,-327 473.48,-286 597.48,-286 597.48,-327"/>
<text text-anchor="middle" x="535.48" y="-315" font-family="Arial" font-size="10.00">Linux:</text>
<text text-anchor="middle" x="535.48" y="-304" font-family="Arial" font-size="10.00">Use sendfile64/sendfile</text>
<text text-anchor="middle" x="535.48" y="-293" font-family="Arial" font-size="10.00">Handle errors and retries</text>
</g>
<!-- os_switch&#45;&gt;linux -->
<g id="edge4" class="edge">
<title>os_switch&#45;&gt;linux</title>
<path fill="none" stroke="black" d="M479.19,-373.7C488.74,-362.46 501.4,-347.58 512.29,-334.78"/>
<polygon fill="black" stroke="black" points="514.98,-337.01 518.8,-327.12 509.65,-332.47 514.98,-337.01"/>
<text text-anchor="middle" x="513.48" y="-348" font-family="Arial" font-size="10.00">.linux</text>
</g>
<!-- freebsd -->
<g id="node8" class="node">
<title>freebsd</title>
<polygon fill="none" stroke="black" points="455.48,-327 331.48,-327 331.48,-286 455.48,-286 455.48,-327"/>
<text text-anchor="middle" x="393.48" y="-315" font-family="Arial" font-size="10.00">FreeBSD:</text>
<text text-anchor="middle" x="393.48" y="-304" font-family="Arial" font-size="10.00">Use sendfile with hdtr</text>
<text text-anchor="middle" x="393.48" y="-293" font-family="Arial" font-size="10.00">Handle errors and retries</text>
</g>
<!-- os_switch&#45;&gt;freebsd -->
<g id="edge5" class="edge">
<title>os_switch&#45;&gt;freebsd</title>
<path fill="none" stroke="black" d="M449.77,-373.7C440.21,-362.46 427.56,-347.58 416.67,-334.78"/>
<polygon fill="black" stroke="black" points="419.31,-332.47 410.16,-327.12 413.97,-337.01 419.31,-332.47"/>
<text text-anchor="middle" x="450.48" y="-348" font-family="Arial" font-size="10.00">.freebsd</text>
</g>
<!-- macos -->
<g id="node9" class="node">
<title>macos</title>
<polygon fill="none" stroke="black" points="739.48,-327 615.48,-327 615.48,-286 739.48,-286 739.48,-327"/>
<text text-anchor="middle" x="677.48" y="-315" font-family="Arial" font-size="10.00">macOS/iOS/etc:</text>
<text text-anchor="middle" x="677.48" y="-304" font-family="Arial" font-size="10.00">Use sendfile with hdtr</text>
<text text-anchor="middle" x="677.48" y="-293" font-family="Arial" font-size="10.00">Handle errors and retries</text>
</g>
<!-- os_switch&#45;&gt;macos -->
<g id="edge6" class="edge">
<title>os_switch&#45;&gt;macos</title>
<path fill="none" stroke="black" d="M508.1,-373.9C539.8,-361.47 583.09,-344.5 617.97,-330.83"/>
<polygon fill="black" stroke="black" points="619.54,-333.97 627.57,-327.06 616.98,-327.46 619.54,-333.97"/>
<text text-anchor="middle" x="610.48" y="-348" font-family="Arial" font-size="10.00">.macos/.ios/etc</text>
</g>
<!-- fallback -->
<g id="node10" class="node">
<title>fallback</title>
<polygon fill="none" stroke="black" points="867.48,-324.5 757.48,-324.5 757.48,-288.5 867.48,-288.5 867.48,-324.5"/>
<text text-anchor="middle" x="812.48" y="-309.5" font-family="Arial" font-size="10.00">Other OS:</text>
<text text-anchor="middle" x="812.48" y="-298.5" font-family="Arial" font-size="10.00">Fallback to read/write</text>
</g>
<!-- os_switch&#45;&gt;fallback -->
<g id="edge7" class="edge">
<title>os_switch&#45;&gt;fallback</title>
<path fill="none" stroke="black" d="M513.56,-382.96C550.78,-376.55 603.1,-366.87 648.48,-356 690.58,-345.91 702.61,-340.86 747.56,-327.28"/>
<polygon fill="black" stroke="black" points="748.76,-330.58 757.33,-324.35 746.75,-323.87 748.76,-330.58"/>
<text text-anchor="middle" x="703.48" y="-348" font-family="Arial" font-size="10.00">default</text>
</g>
<!-- trailers_check -->
<g id="node14" class="node">
<title>trailers_check</title>
<polygon fill="none" stroke="black" points="626.98,-218 539.98,-218 539.98,-182 626.98,-182 626.98,-218"/>
<text text-anchor="middle" x="583.48" y="-197.5" font-family="Arial" font-size="10.00">trailers.len != 0?</text>
</g>
<!-- linux&#45;&gt;trailers_check -->
<g id="edge12" class="edge">
<title>linux&#45;&gt;trailers_check</title>
<path fill="none" stroke="black" d="M559.19,-285.94C564.3,-280.63 569.16,-274.52 572.48,-268 578.7,-255.77 581.54,-240.81 582.78,-228.13"/>
<polygon fill="black" stroke="black" points="586.28,-228.35 583.49,-218.13 579.29,-227.85 586.28,-228.35"/>
<text text-anchor="middle" x="618.48" y="-260" font-family="Arial" font-size="10.00">Fallback if EINVAL</text>
</g>
<!-- linux&#45;&gt;error_check -->
<g id="edge20" class="edge">
<title>linux&#45;&gt;error_check</title>
<path fill="none" stroke="black" d="M531.5,-285.99C528.37,-275.72 522.89,-263.87 513.48,-257 501.01,-247.9 459.38,-253.02 444.48,-249 421.03,-242.68 396.14,-232.16 375.97,-222.58"/>
<polygon fill="black" stroke="black" points="377.29,-219.34 366.77,-218.12 374.24,-225.64 377.29,-219.34"/>
<text text-anchor="middle" x="540.48" y="-260" font-family="Arial" font-size="10.00">On error</text>
</g>
<!-- freebsd&#45;&gt;trailers_check -->
<g id="edge13" class="edge">
<title>freebsd&#45;&gt;trailers_check</title>
<path fill="none" stroke="black" d="M382.83,-285.53C379.26,-275.87 377.71,-264.73 384.48,-257 393.34,-246.88 431.39,-252.1 444.48,-249 473.89,-242.04 505.82,-231.25 531.65,-221.66"/>
<polygon fill="black" stroke="black" points="533.11,-224.85 541.24,-218.06 530.65,-218.3 533.11,-224.85"/>
<text text-anchor="middle" x="448.98" y="-260" font-family="Arial" font-size="10.00">Fallback if ENOSYS/EINVAL</text>
</g>
<!-- freebsd&#45;&gt;error_check -->
<g id="edge21" class="edge">
<title>freebsd&#45;&gt;error_check</title>
<path fill="none" stroke="black" d="M342.83,-285.93C335.91,-281.11 329.73,-275.2 325.48,-268 318.41,-256.04 319.81,-240.82 323.35,-227.9"/>
<polygon fill="black" stroke="black" points="326.75,-228.74 326.52,-218.15 320.1,-226.58 326.75,-228.74"/>
<text text-anchor="middle" x="343.48" y="-260" font-family="Arial" font-size="10.00">On error</text>
</g>
<!-- macos&#45;&gt;trailers_check -->
<g id="edge14" class="edge">
<title>macos&#45;&gt;trailers_check</title>
<path fill="none" stroke="black" d="M726.12,-285.99C738.49,-278.09 746.33,-268.18 738.48,-257 715.74,-224.6 672.31,-210.87 637.19,-205.08"/>
<polygon fill="black" stroke="black" points="637.47,-201.59 627.07,-203.59 636.45,-208.51 637.47,-201.59"/>
<text text-anchor="middle" x="786.98" y="-260" font-family="Arial" font-size="10.00">Fallback if ENOSYS</text>
</g>
<!-- macos&#45;&gt;error_check -->
<g id="edge22" class="edge">
<title>macos&#45;&gt;error_check</title>
<path fill="none" stroke="black" d="M677.47,-285.98C676.35,-275.7 673.07,-263.84 664.48,-257 645.35,-241.76 468.33,-254.43 444.48,-249 420.17,-243.46 394.55,-232.61 374.15,-222.63"/>
<polygon fill="black" stroke="black" points="375.68,-219.48 365.18,-218.12 372.54,-225.74 375.68,-219.48"/>
<text text-anchor="middle" x="690.48" y="-260" font-family="Arial" font-size="10.00">On error</text>
</g>
<!-- fallback&#45;&gt;trailers_check -->
<g id="edge15" class="edge">
<title>fallback&#45;&gt;trailers_check</title>
<path fill="none" stroke="black" d="M830.12,-288.28C838.01,-278.5 844.01,-266.38 836.48,-257 812.02,-226.53 704.27,-211.63 637.52,-205.19"/>
<polygon fill="black" stroke="black" points="637.46,-201.67 627.18,-204.23 636.81,-208.64 637.46,-201.67"/>
</g>
<!-- rw_block -->
<g id="node11" class="node">
<title>rw_block</title>
<polygon fill="none" stroke="black" points="156.48,-327 46.48,-327 46.48,-286 156.48,-286 156.48,-327"/>
<text text-anchor="middle" x="101.48" y="-315" font-family="Arial" font-size="10.00">Read data via pread()</text>
<text text-anchor="middle" x="101.48" y="-304" font-family="Arial" font-size="10.00">Write via write()</text>
<text text-anchor="middle" x="101.48" y="-293" font-family="Arial" font-size="10.00">Update total_written</text>
</g>
<!-- rw_block&#45;&gt;error_check -->
<g id="edge27" class="edge">
<title>rw_block&#45;&gt;error_check</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M143.97,-285.9C163.32,-277.01 186.53,-266.41 207.48,-257 234.84,-244.71 265.62,-231.13 290.02,-220.42"/>
<polygon fill="black" stroke="black" points="291.63,-223.54 299.38,-216.32 288.82,-217.13 291.63,-223.54"/>
</g>
<!-- check_in_len -->
<g id="node12" class="node">
<title>check_in_len</title>
<polygon fill="none" stroke="black" points="171.98,-410 100.98,-410 100.98,-374 171.98,-374 171.98,-410"/>
<text text-anchor="middle" x="136.48" y="-389.5" font-family="Arial" font-size="10.00">in_len == 0?</text>
</g>
<!-- check_in_len&#45;&gt;rw_block -->
<g id="edge10" class="edge">
<title>check_in_len&#45;&gt;rw_block</title>
<path fill="none" stroke="black" d="M129.23,-373.7C124.74,-362.99 118.86,-348.98 113.68,-336.6"/>
<polygon fill="black" stroke="black" points="116.8,-334.99 109.7,-327.12 110.34,-337.7 116.8,-334.99"/>
<text text-anchor="middle" x="126.98" y="-348" font-family="Arial" font-size="10.00">No</text>
</g>
<!-- break_rw -->
<g id="node13" class="node">
<title>break_rw</title>
<polygon fill="none" stroke="black" points="237.98,-324.5 174.98,-324.5 174.98,-288.5 237.98,-288.5 237.98,-324.5"/>
<text text-anchor="middle" x="206.48" y="-304" font-family="Arial" font-size="10.00">Break loop</text>
</g>
<!-- check_in_len&#45;&gt;break_rw -->
<g id="edge11" class="edge">
<title>check_in_len&#45;&gt;break_rw</title>
<path fill="none" stroke="black" d="M150.98,-373.7C160.93,-361.83 174.29,-345.89 185.41,-332.63"/>
<polygon fill="black" stroke="black" points="188.25,-334.69 191.99,-324.78 182.89,-330.19 188.25,-334.69"/>
<text text-anchor="middle" x="181.98" y="-348" font-family="Arial" font-size="10.00">Yes</text>
</g>
<!-- trailers_check&#45;&gt;end -->
<g id="edge17" class="edge">
<title>trailers_check&#45;&gt;end</title>
<path fill="none" stroke="black" d="M588.8,-181.91C594.69,-159.74 601.62,-120.43 587.48,-91 581.13,-77.79 569.98,-66.73 558.43,-58.01"/>
<polygon fill="black" stroke="black" points="560.2,-54.98 550,-52.09 556.17,-60.7 560.2,-54.98"/>
<text text-anchor="middle" x="601.98" y="-114.5" font-family="Arial" font-size="10.00">No</text>
</g>
<!-- trailers_writev -->
<g id="node15" class="node">
<title>trailers_writev</title>
<polygon fill="none" stroke="black" points="578.48,-135 456.48,-135 456.48,-99 578.48,-99 578.48,-135"/>
<text text-anchor="middle" x="517.48" y="-120" font-family="Arial" font-size="10.00">Write trailers via writev()</text>
<text text-anchor="middle" x="517.48" y="-109" font-family="Arial" font-size="10.00">Update total_written</text>
</g>
<!-- trailers_check&#45;&gt;trailers_writev -->
<g id="edge16" class="edge">
<title>trailers_check&#45;&gt;trailers_writev</title>
<path fill="none" stroke="black" d="M569.48,-181.82C560.29,-170.55 548.12,-155.61 537.87,-143.02"/>
<polygon fill="black" stroke="black" points="540.49,-140.69 531.45,-135.15 535.06,-145.12 540.49,-140.69"/>
<text text-anchor="middle" x="561.98" y="-156" font-family="Arial" font-size="10.00">Yes</text>
</g>
<!-- trailers_writev&#45;&gt;end -->
<g id="edge18" class="edge">
<title>trailers_writev&#45;&gt;end</title>
<path fill="none" stroke="black" d="M517.48,-98.82C517.48,-88.19 517.48,-74.31 517.48,-62.2"/>
<polygon fill="black" stroke="black" points="520.98,-62.15 517.48,-52.15 513.98,-62.15 520.98,-62.15"/>
</g>
<!-- trailers_writev&#45;&gt;error_check -->
<g id="edge26" class="edge">
<title>trailers_writev&#45;&gt;error_check</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M478.82,-135.11C449.61,-148.04 409.45,-165.82 378.91,-179.33"/>
<polygon fill="black" stroke="black" points="377.49,-176.13 369.76,-183.38 380.32,-182.54 377.49,-176.13"/>
</g>
<!-- handle_errors -->
<g id="node17" class="node">
<title>handle_errors</title>
<polygon fill="none" stroke="black" points="410.98,-135 257.98,-135 257.98,-99 410.98,-99 410.98,-135"/>
<text text-anchor="middle" x="334.48" y="-120" font-family="Arial" font-size="10.00">Handle specific errors</text>
<text text-anchor="middle" x="334.48" y="-109" font-family="Arial" font-size="10.00">(e.g., WouldBlock, BrokenPipe)</text>
</g>
<!-- error_check&#45;&gt;handle_errors -->
<g id="edge19" class="edge">
<title>error_check&#45;&gt;handle_errors</title>
<path fill="none" stroke="black" d="M334.48,-181.82C334.48,-171.19 334.48,-157.31 334.48,-145.2"/>
<polygon fill="black" stroke="black" points="337.98,-145.15 334.48,-135.15 330.98,-145.15 337.98,-145.15"/>
</g>
<!-- handle_errors&#45;&gt;end -->
<g id="edge23" class="edge">
<title>handle_errors&#45;&gt;end</title>
<path fill="none" stroke="black" d="M350.91,-98.99C361.18,-89.24 375.14,-77.5 389.48,-70 410.19,-59.17 434.59,-51.43 456.51,-46.03"/>
<polygon fill="black" stroke="black" points="457.44,-49.4 466.38,-43.71 455.84,-42.59 457.44,-49.4"/>
<text text-anchor="middle" x="451.48" y="-73" font-family="Arial" font-size="10.00">Return error if unrecoverable</text>
</g>
<!-- handle_errors&#45;&gt;os_switch -->
<g id="edge24" class="edge">
<title>handle_errors&#45;&gt;os_switch</title>
<path fill="none" stroke="black" d="M311.47,-135.07C277.58,-162.41 220.82,-218.04 245.48,-268 275.82,-329.48 351.49,-361.83 405.37,-377.65"/>
<polygon fill="black" stroke="black" points="404.59,-381.07 415.16,-380.42 406.49,-374.33 404.59,-381.07"/>
<text text-anchor="middle" x="281.48" y="-260" font-family="Arial" font-size="10.00">Retry if possible</text>
</g>
</g>
</svg>
