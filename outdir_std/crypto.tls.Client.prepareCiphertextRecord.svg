<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: prepareCiphertextRecord Pages: 1 -->
<svg width="993pt" height="1218pt"
 viewBox="0.00 0.00 992.50 1218.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1214)">
<title>prepareCiphertextRecord</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-1214 988.5,-1214 988.5,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_tls13</title>
<polygon fill="none" stroke="black" points="8,-8 8,-987 757,-987 757,-8 8,-8"/>
<text text-anchor="middle" x="382.5" y="-971.8" font-family="Times,serif" font-size="14.00">TLS 1.3 流程</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_tls12</title>
<polygon fill="none" stroke="black" points="765,-912 765,-987 915,-987 915,-912 765,-912"/>
<text text-anchor="middle" x="840" y="-971.8" font-family="Times,serif" font-size="14.00">TLS 1.2 流程</text>
</g>
<!-- start -->
<g id="node1" class="node">
<title>start</title>
<polygon fill="none" stroke="black" points="876,-1210 644,-1210 644,-1174 876,-1174 876,-1210"/>
<text text-anchor="middle" x="760" y="-1188.3" font-family="Times,serif" font-size="14.00">开始 prepareCiphertextRecord</text>
</g>
<!-- init_vars -->
<g id="node2" class="node">
<title>init_vars</title>
<polygon fill="none" stroke="black" points="984.5,-1137 535.5,-1137 535.5,-1101 984.5,-1101 984.5,-1137"/>
<text text-anchor="middle" x="760" y="-1115.3" font-family="Times,serif" font-size="14.00">初始化变量：cleartext_buf, ciphertext_end, iovec_end, bytes_i</text>
</g>
<!-- start&#45;&gt;init_vars -->
<g id="edge1" class="edge">
<title>start&#45;&gt;init_vars</title>
<path fill="none" stroke="black" d="M760,-1173.81C760,-1165.79 760,-1156.05 760,-1147.07"/>
<polygon fill="black" stroke="black" points="763.5,-1147.03 760,-1137.03 756.5,-1147.03 763.5,-1147.03"/>
</g>
<!-- switch_cipher -->
<g id="node3" class="node">
<title>switch_cipher</title>
<polygon fill="none" stroke="black" points="930.5,-1064 589.5,-1064 589.5,-1028 930.5,-1028 930.5,-1064"/>
<text text-anchor="middle" x="760" y="-1042.3" font-family="Times,serif" font-size="14.00">根据 application_cipher 和 tls_version 选择分支</text>
</g>
<!-- init_vars&#45;&gt;switch_cipher -->
<g id="edge2" class="edge">
<title>init_vars&#45;&gt;switch_cipher</title>
<path fill="none" stroke="black" d="M760,-1100.81C760,-1092.79 760,-1083.05 760,-1074.07"/>
<polygon fill="black" stroke="black" points="763.5,-1074.03 760,-1064.03 756.5,-1074.03 763.5,-1074.03"/>
</g>
<!-- tls13 -->
<g id="node4" class="node">
<title>tls13</title>
<polygon fill="none" stroke="black" points="746.5,-956 613.5,-956 613.5,-920 746.5,-920 746.5,-956"/>
<text text-anchor="middle" x="680" y="-934.3" font-family="Times,serif" font-size="14.00">TLS 1.3 处理分支</text>
</g>
<!-- switch_cipher&#45;&gt;tls13 -->
<g id="edge3" class="edge">
<title>switch_cipher&#45;&gt;tls13</title>
<path fill="none" stroke="black" d="M747.15,-1027.97C734.22,-1010.84 714.13,-984.22 699.29,-964.56"/>
<polygon fill="black" stroke="black" points="701.91,-962.21 693.09,-956.34 696.32,-966.43 701.91,-962.21"/>
<text text-anchor="middle" x="756" y="-998.8" font-family="Times,serif" font-size="14.00">tls_1_3</text>
</g>
<!-- tls12 -->
<g id="node5" class="node">
<title>tls12</title>
<polygon fill="none" stroke="black" points="906.5,-956 773.5,-956 773.5,-920 906.5,-920 906.5,-956"/>
<text text-anchor="middle" x="840" y="-934.3" font-family="Times,serif" font-size="14.00">TLS 1.2 处理分支</text>
</g>
<!-- switch_cipher&#45;&gt;tls12 -->
<g id="edge4" class="edge">
<title>switch_cipher&#45;&gt;tls12</title>
<path fill="none" stroke="black" d="M772.85,-1027.97C785.78,-1010.84 805.87,-984.22 820.71,-964.56"/>
<polygon fill="black" stroke="black" points="823.68,-966.43 826.91,-956.34 818.09,-962.21 823.68,-966.43"/>
<text text-anchor="middle" x="822" y="-998.8" font-family="Times,serif" font-size="14.00">tls_1_2</text>
</g>
<!-- loop_start -->
<g id="node6" class="node">
<title>loop_start</title>
<polygon fill="none" stroke="black" points="748.5,-883 603.5,-883 603.5,-847 748.5,-847 748.5,-883"/>
<text text-anchor="middle" x="676" y="-861.3" font-family="Times,serif" font-size="14.00">进入循环处理数据块</text>
</g>
<!-- tls13&#45;&gt;loop_start -->
<g id="edge5" class="edge">
<title>tls13&#45;&gt;loop_start</title>
<path fill="none" stroke="black" d="M679.03,-919.81C678.58,-911.79 678.03,-902.05 677.53,-893.07"/>
<polygon fill="black" stroke="black" points="681.02,-892.82 676.96,-883.03 674.03,-893.21 681.02,-892.82"/>
</g>
<!-- tls12&#45;&gt;loop_start -->
<g id="edge19" class="edge">
<title>tls12&#45;&gt;loop_start</title>
<path fill="none" stroke="black" d="M800.72,-919.99C777.96,-910.14 749.12,-897.66 724.9,-887.17"/>
<polygon fill="black" stroke="black" points="726.1,-883.87 715.53,-883.11 723.32,-890.3 726.1,-883.87"/>
</g>
<!-- calc_length -->
<g id="node7" class="node">
<title>calc_length</title>
<polygon fill="none" stroke="black" points="709,-810 293,-810 293,-774 709,-774 709,-810"/>
<text text-anchor="middle" x="501" y="-788.3" font-family="Times,serif" font-size="14.00">计算加密内容长度（encrypted_content_len/message_len）</text>
</g>
<!-- loop_start&#45;&gt;calc_length -->
<g id="edge6" class="edge">
<title>loop_start&#45;&gt;calc_length</title>
<path fill="none" stroke="black" d="M628.22,-846.99C602.79,-837.1 571.72,-824.54 546.62,-814.03"/>
<polygon fill="black" stroke="black" points="547.89,-810.77 537.31,-810.11 545.17,-817.22 547.89,-810.77"/>
</g>
<!-- loop_start&#45;&gt;calc_length -->
<g id="edge20" class="edge">
<title>loop_start&#45;&gt;calc_length</title>
<path fill="none" stroke="black" d="M639.94,-846.99C616.5,-837.06 585.51,-824.43 558.71,-813.89"/>
<polygon fill="black" stroke="black" points="559.64,-810.5 549.05,-810.11 557.09,-817.02 559.64,-810.5"/>
</g>
<!-- check_zero -->
<g id="node8" class="node">
<title>check_zero</title>
<polygon fill="none" stroke="black" points="501,-737 398.95,-719 501,-701 603.05,-719 501,-737"/>
<text text-anchor="middle" x="501" y="-715.3" font-family="Times,serif" font-size="14.00">长度是否为0？</text>
</g>
<!-- calc_length&#45;&gt;check_zero -->
<g id="edge7" class="edge">
<title>calc_length&#45;&gt;check_zero</title>
<path fill="none" stroke="black" d="M495.12,-773.81C494.26,-765.55 494.04,-755.47 494.46,-746.28"/>
<polygon fill="black" stroke="black" points="497.97,-746.3 495.25,-736.06 490.99,-745.76 497.97,-746.3"/>
</g>
<!-- calc_length&#45;&gt;check_zero -->
<g id="edge21" class="edge">
<title>calc_length&#45;&gt;check_zero</title>
<path fill="none" stroke="black" d="M506.88,-773.81C507.74,-765.55 507.96,-755.47 507.54,-746.28"/>
<polygon fill="black" stroke="black" points="511.01,-745.76 506.75,-736.06 504.03,-746.3 511.01,-745.76"/>
</g>
<!-- return -->
<g id="node9" class="node">
<title>return</title>
<ellipse fill="none" stroke="black" cx="261" cy="-632" rx="245.06" ry="18"/>
<text text-anchor="middle" x="261" y="-628.3" font-family="Times,serif" font-size="14.00">返回结果：iovec_end, ciphertext_end, overhead_len</text>
</g>
<!-- check_zero&#45;&gt;return -->
<g id="edge8" class="edge">
<title>check_zero&#45;&gt;return</title>
<path fill="none" stroke="black" d="M468.63,-706.54C429.97,-692.84 364.62,-669.7 317.55,-653.03"/>
<polygon fill="black" stroke="black" points="318.69,-649.72 308.1,-649.68 316.35,-656.32 318.69,-649.72"/>
<text text-anchor="middle" x="402.5" y="-671.8" font-family="Times,serif" font-size="14.00">是</text>
</g>
<!-- check_zero&#45;&gt;return -->
<g id="edge22" class="edge">
<title>check_zero&#45;&gt;return</title>
<path fill="none" stroke="black" d="M481.12,-704.28C464.02,-693.06 438.33,-677.53 414,-668 397.01,-661.35 378.44,-655.78 360.28,-651.18"/>
<polygon fill="black" stroke="black" points="361.08,-647.78 350.54,-648.8 359.42,-654.58 361.08,-647.78"/>
<text text-anchor="middle" x="450.5" y="-671.8" font-family="Times,serif" font-size="14.00">是</text>
</g>
<!-- copy_data -->
<g id="node10" class="node">
<title>copy_data</title>
<polygon fill="none" stroke="black" points="709.5,-650 524.5,-650 524.5,-614 709.5,-614 709.5,-650"/>
<text text-anchor="middle" x="617" y="-628.3" font-family="Times,serif" font-size="14.00">拷贝数据到 cleartext_buf</text>
</g>
<!-- check_zero&#45;&gt;copy_data -->
<g id="edge9" class="edge">
<title>check_zero&#45;&gt;copy_data</title>
<path fill="none" stroke="black" d="M519.9,-704.15C537.61,-691.17 564.44,-671.51 585.41,-656.14"/>
<polygon fill="black" stroke="black" points="587.71,-658.8 593.71,-650.07 583.57,-653.15 587.71,-658.8"/>
<text text-anchor="middle" x="572.5" y="-671.8" font-family="Times,serif" font-size="14.00">否</text>
</g>
<!-- check_zero&#45;&gt;copy_data -->
<g id="edge23" class="edge">
<title>check_zero&#45;&gt;copy_data</title>
<path fill="none" stroke="black" d="M538.29,-707.56C553.58,-702 570.77,-693.99 584,-683 591.87,-676.46 598.57,-667.56 603.83,-659.08"/>
<polygon fill="black" stroke="black" points="607,-660.59 608.96,-650.18 600.94,-657.09 607,-660.59"/>
<text text-anchor="middle" x="604.5" y="-671.8" font-family="Times,serif" font-size="14.00">否</text>
</g>
<!-- add_inner_type -->
<g id="node11" class="node">
<title>add_inner_type</title>
<polygon fill="none" stroke="black" points="620.5,-577 333.5,-577 333.5,-541 620.5,-541 620.5,-577"/>
<text text-anchor="middle" x="477" y="-555.3" font-family="Times,serif" font-size="14.00">TLS 1.3：追加 inner_content_type 字节</text>
</g>
<!-- copy_data&#45;&gt;add_inner_type -->
<g id="edge10" class="edge">
<title>copy_data&#45;&gt;add_inner_type</title>
<path fill="none" stroke="black" d="M583.47,-613.99C564.39,-604.32 540.29,-592.1 519.85,-581.73"/>
<polygon fill="black" stroke="black" points="521.25,-578.52 510.75,-577.11 518.08,-584.76 521.25,-578.52"/>
</g>
<!-- build_header -->
<g id="node12" class="node">
<title>build_header</title>
<polygon fill="none" stroke="black" points="593.5,-504 456.5,-504 456.5,-468 593.5,-468 593.5,-504"/>
<text text-anchor="middle" x="525" y="-482.3" font-family="Times,serif" font-size="14.00">构造记录头（AD）</text>
</g>
<!-- copy_data&#45;&gt;build_header -->
<g id="edge24" class="edge">
<title>copy_data&#45;&gt;build_header</title>
<path fill="none" stroke="black" d="M625.75,-613.75C634.13,-594.57 643.65,-563.37 630,-541 621.47,-527.02 608.03,-516.5 593.58,-508.65"/>
<polygon fill="black" stroke="black" points="595,-505.45 584.49,-504.1 591.87,-511.71 595,-505.45"/>
</g>
<!-- add_inner_type&#45;&gt;build_header -->
<g id="edge11" class="edge">
<title>add_inner_type&#45;&gt;build_header</title>
<path fill="none" stroke="black" d="M488.62,-540.81C494.4,-532.27 501.49,-521.77 507.88,-512.32"/>
<polygon fill="black" stroke="black" points="510.79,-514.27 513.49,-504.03 504.99,-510.35 510.79,-514.27"/>
</g>
<!-- generate_nonce -->
<g id="node13" class="node">
<title>generate_nonce</title>
<polygon fill="none" stroke="black" points="572,-417 478,-417 478,-381 572,-381 572,-417"/>
<text text-anchor="middle" x="525" y="-395.3" font-family="Times,serif" font-size="14.00">生成 Nonce</text>
</g>
<!-- build_header&#45;&gt;generate_nonce -->
<g id="edge12" class="edge">
<title>build_header&#45;&gt;generate_nonce</title>
<path fill="none" stroke="black" d="M519.45,-467.8C518.19,-456.16 517.92,-440.55 518.65,-427.24"/>
<polygon fill="black" stroke="black" points="522.15,-427.42 519.45,-417.18 515.17,-426.87 522.15,-427.42"/>
</g>
<!-- build_header&#45;&gt;generate_nonce -->
<g id="edge25" class="edge">
<title>build_header&#45;&gt;generate_nonce</title>
<path fill="none" stroke="black" d="M530.55,-467.8C531.81,-456.16 532.08,-440.55 531.35,-427.24"/>
<polygon fill="black" stroke="black" points="534.83,-426.87 530.55,-417.18 527.85,-427.42 534.83,-426.87"/>
</g>
<!-- encrypt_data -->
<g id="node14" class="node">
<title>encrypt_data</title>
<polygon fill="none" stroke="black" points="586.5,-344 463.5,-344 463.5,-308 586.5,-308 586.5,-344"/>
<text text-anchor="middle" x="525" y="-322.3" font-family="Times,serif" font-size="14.00">执行 AEAD 加密</text>
</g>
<!-- generate_nonce&#45;&gt;encrypt_data -->
<g id="edge13" class="edge">
<title>generate_nonce&#45;&gt;encrypt_data</title>
<path fill="none" stroke="black" d="M519.12,-380.81C518.28,-372.79 518.05,-363.05 518.42,-354.07"/>
<polygon fill="black" stroke="black" points="521.92,-354.25 519.14,-344.03 514.94,-353.75 521.92,-354.25"/>
</g>
<!-- generate_nonce&#45;&gt;encrypt_data -->
<g id="edge26" class="edge">
<title>generate_nonce&#45;&gt;encrypt_data</title>
<path fill="none" stroke="black" d="M530.88,-380.81C531.72,-372.79 531.95,-363.05 531.58,-354.07"/>
<polygon fill="black" stroke="black" points="535.06,-353.75 530.86,-344.03 528.08,-354.25 535.06,-353.75"/>
</g>
<!-- update_seq -->
<g id="node15" class="node">
<title>update_seq</title>
<polygon fill="none" stroke="black" points="584,-271 466,-271 466,-235 584,-235 584,-271"/>
<text text-anchor="middle" x="525" y="-249.3" font-family="Times,serif" font-size="14.00">递增 write_seq</text>
</g>
<!-- encrypt_data&#45;&gt;update_seq -->
<g id="edge14" class="edge">
<title>encrypt_data&#45;&gt;update_seq</title>
<path fill="none" stroke="black" d="M519.12,-307.81C518.28,-299.79 518.05,-290.05 518.42,-281.07"/>
<polygon fill="black" stroke="black" points="521.92,-281.25 519.14,-271.03 514.94,-280.75 521.92,-281.25"/>
</g>
<!-- encrypt_data&#45;&gt;update_seq -->
<g id="edge27" class="edge">
<title>encrypt_data&#45;&gt;update_seq</title>
<path fill="none" stroke="black" d="M530.88,-307.81C531.72,-299.79 531.95,-290.05 531.58,-281.07"/>
<polygon fill="black" stroke="black" points="535.06,-280.75 530.86,-271.03 528.08,-281.25 535.06,-280.75"/>
</g>
<!-- update_buffers -->
<g id="node16" class="node">
<title>update_buffers</title>
<polygon fill="none" stroke="black" points="649,-198 401,-198 401,-162 649,-162 649,-198"/>
<text text-anchor="middle" x="525" y="-176.3" font-family="Times,serif" font-size="14.00">更新 ciphertext_end 和 iovec_end</text>
</g>
<!-- update_seq&#45;&gt;update_buffers -->
<g id="edge15" class="edge">
<title>update_seq&#45;&gt;update_buffers</title>
<path fill="none" stroke="black" d="M519.12,-234.81C518.28,-226.79 518.05,-217.05 518.42,-208.07"/>
<polygon fill="black" stroke="black" points="521.92,-208.25 519.14,-198.03 514.94,-207.75 521.92,-208.25"/>
</g>
<!-- update_seq&#45;&gt;update_buffers -->
<g id="edge28" class="edge">
<title>update_seq&#45;&gt;update_buffers</title>
<path fill="none" stroke="black" d="M530.88,-234.81C531.72,-226.79 531.95,-217.05 531.58,-208.07"/>
<polygon fill="black" stroke="black" points="535.06,-207.75 530.86,-198.03 528.08,-208.25 535.06,-207.75"/>
</g>
<!-- add_to_iovec -->
<g id="node17" class="node">
<title>add_to_iovec</title>
<polygon fill="none" stroke="black" points="631.5,-125 452.5,-125 452.5,-89 631.5,-89 631.5,-125"/>
<text text-anchor="middle" x="542" y="-103.3" font-family="Times,serif" font-size="14.00">将加密记录添加到 iovecs</text>
</g>
<!-- update_buffers&#45;&gt;add_to_iovec -->
<g id="edge16" class="edge">
<title>update_buffers&#45;&gt;add_to_iovec</title>
<path fill="none" stroke="black" d="M523.24,-161.81C524.33,-153.7 526.46,-143.84 529.02,-134.78"/>
<polygon fill="black" stroke="black" points="532.43,-135.62 532.06,-125.03 525.74,-133.53 532.43,-135.62"/>
</g>
<!-- update_buffers&#45;&gt;add_to_iovec -->
<g id="edge29" class="edge">
<title>update_buffers&#45;&gt;add_to_iovec</title>
<path fill="none" stroke="black" d="M534.99,-161.81C537.75,-153.79 540.32,-144.05 542.1,-135.07"/>
<polygon fill="black" stroke="black" points="545.58,-135.47 543.78,-125.03 538.67,-134.31 545.58,-135.47"/>
</g>
<!-- loop_cond -->
<g id="node18" class="node">
<title>loop_cond</title>
<polygon fill="none" stroke="black" points="614,-52 545.96,-34 614,-16 682.04,-34 614,-52"/>
<text text-anchor="middle" x="614" y="-30.3" font-family="Times,serif" font-size="14.00">继续循环</text>
</g>
<!-- add_to_iovec&#45;&gt;loop_cond -->
<g id="edge17" class="edge">
<title>add_to_iovec&#45;&gt;loop_cond</title>
<path fill="none" stroke="black" d="M553.55,-88.81C563.1,-78.31 576.68,-64.86 588.64,-54.03"/>
<polygon fill="black" stroke="black" points="591.02,-56.6 596.2,-47.36 586.39,-51.35 591.02,-56.6"/>
</g>
<!-- add_to_iovec&#45;&gt;loop_cond -->
<g id="edge30" class="edge">
<title>add_to_iovec&#45;&gt;loop_cond</title>
<path fill="none" stroke="black" d="M565.31,-88.81C575.99,-79.26 588.28,-67.28 597.94,-57.05"/>
<polygon fill="black" stroke="black" points="600.56,-59.37 604.75,-49.63 595.41,-54.63 600.56,-59.37"/>
</g>
<!-- loop_cond&#45;&gt;loop_start -->
<g id="edge18" class="edge">
<title>loop_cond&#45;&gt;loop_start</title>
<path fill="none" stroke="black" d="M631.68,-47.49C647.43,-60.22 668,-81.53 668,-106 668,-400 668,-400 668,-400 668,-422.23 665.5,-428.05 669,-450 685.23,-551.88 728,-571.33 728,-674.5 728,-793 728,-793 728,-793 728,-810.84 717.18,-827.18 705.41,-839.67"/>
<polygon fill="black" stroke="black" points="702.71,-837.42 698.05,-846.93 707.63,-842.4 702.71,-837.42"/>
<text text-anchor="middle" x="683.5" y="-438.8" font-family="Times,serif" font-size="14.00">继续</text>
</g>
<!-- loop_cond&#45;&gt;loop_start -->
<g id="edge31" class="edge">
<title>loop_cond&#45;&gt;loop_start</title>
<path fill="none" stroke="black" d="M648.71,-42.86C679.62,-52.16 720,-71 720,-106 720,-400 720,-400 720,-400 720,-522.63 748,-551.87 748,-674.5 748,-793 748,-793 748,-793 748,-812.88 733.91,-829.07 718.19,-840.94"/>
<polygon fill="black" stroke="black" points="716.08,-838.15 709.89,-846.75 720.09,-843.88 716.08,-838.15"/>
<text text-anchor="middle" x="735.5" y="-438.8" font-family="Times,serif" font-size="14.00">继续</text>
</g>
</g>
</svg>
