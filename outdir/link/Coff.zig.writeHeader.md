graph TD
    A[开始] --> B[获取目标信息和初始化缓冲区]
    B --> C[写入MS-DOS存根并更新偏移]
    C --> D[写入PE签名]
    D --> E[设置COFF头标志]
    E --> F{判断架构位数}
    F -->|32位| G[设置32BIT_MACHINE标志]
    F -->|64位| H[设置LARGE_ADDRESS_AWARE标志]
    G --> I[判断是否为动态库]
    H --> I
    I -->|是| J[设置DLL标志]
    I -->|否| K[跳过DLL标志]
    J --> L[处理时间戳]
    K --> L
    L --> M[填充COFF头结构体]
    M --> N[写入COFF头到缓冲区]
    N --> O[设置DLL特性标志]
    O --> P[遍历节计算代码/数据大小]
    P --> Q{判断架构位数}
    Q -->|32位| R[构造32位可选头]
    Q -->|64位| S[构造64位可选头]
    R --> T[写入32位可选头]
    S --> U[写入64位可选头]
    T --> V[将缓冲区内容写入文件]
    U --> V
    V --> W[结束]
    
    style A fill:#90EE90,stroke:#006400
    style W fill:#FFA07A,stroke:#8B0000
