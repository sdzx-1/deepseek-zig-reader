graph TD
    A[开始] --> B[初始化work_queue_wait_group和link_task_wait_group]
    B --> C[启动link_task_queue]
    C --> D{是否有文档生成?}
    D -- 是 --> E[生成workerDocsCopy和workerDocsWasm任务]
    D -- 否 --> F[处理运行时库构建]
    F --> F1[检查compiler_rt_lib]
    F1 -- 需要构建 --> F2[生成buildRt任务]
    F --> F3[检查compiler_rt_obj...]
    F3 -- 需要构建 --> F4[生成对应任务]
    F --> F5[检查glibc_shared_objects等]
    F5 -- 需要构建 --> F6[生成对应库构建任务]
    F --> F7[处理不同C运行时的Crt文件]
    F7 --> F71[遍历musl/glibc/wasi/mingw枚举]
    F71 -- 需要构建 --> F72[生成对应CrtFile任务]

    F --> G[进入AST生成阶段]
    G --> G1[处理builtin.zig更新]
    G1 -- 更新 --> G11[生成workerUpdateBuiltinZigFile任务]
    G --> G2[处理astgen_work_queue]
    G2 -- 读取文件索引 --> G21[生成workerUpdateFile任务]
    G --> G3[处理嵌入文件]
    G3 -- 遍历embed_table --> G31[生成workerUpdateEmbedFile任务]
    G --> G4[处理C对象和Win32资源]
    G4 -- 读取队列项 --> G41[生成对应worker任务]

    G --> H[检查zcu是否存在]
    H -- 存在 --> H1[激活PerThread]
    H1 --> H2[处理缓存模式]
    H2 -- whole模式 --> H21[添加文件到缓存清单]
    H2 -- incremental模式 --> H22[跳过]
    H1 --> H3[检查文件错误]
    H3 -- 存在错误 --> H31[设置跳过分析并返回]
    H3 -- 无错误 --> H4[处理增量编译]
    H4 -- 需要更新ZIR引用 --> H41[执行updateZirRefs]
    H --> H5[等待链接任务完成]
    H5 --> H6{是否允许分离代码生成?}
    H6 -- 否 --> H61[等待link_task_wait_group]
    H61 --> H62[检查prelink任务错误]
    H62 -- 存在错误 --> H63[返回]
    H62 -- 无错误 --> J[处理工作队列循环]
    J --> J1[读取工作队列项]
    J1 -- 有任务 --> J2[执行processOneJob]
    J2 --> J1
    J1 -- 无任务 --> J3{检查是否需要分析过时项?}
    J3 -- 存在 --> J4[生成分析任务并循环]
    J3 -- 不存在 --> K[结束]
